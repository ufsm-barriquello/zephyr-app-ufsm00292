üóìÔ∏è Semana 6: O Protocolo Propriet√°rio (Vendor Specific Setup)
Sintoma: O sistema estava est√°vel, mas certas funcionalidades avan√ßadas (como alterar a pot√™ncia de TX ou ler o endere√ßo MAC real do chip) falhavam ou retornavam valores padr√£o gen√©ricos (00:00:00:00:00:00).

Investiga√ß√£o: Descobrimos que o BTLC1000 √© um chip baseada em ROM, mas que requer um "Patch" de firmware na RAM inicializa√ß√£o para corrigir bugs do sil√≠cio e habilitar recursos modernos. O driver padr√£o bt_hci_uart do Zephyr assume um controlador HCI gen√©rico e n√£o enviava esse patch.

A Descoberta: Ao comparar o log de inicializa√ß√£o do Zephyr com o log da SDK oficial da Atmel (via Microchip Studio), notamos uma sequ√™ncia de comandos estranha no in√≠cio: Opcode 0xFC00.

Isso √© um comando Vendor Specific.

O r√°dio estava operando em "modo de compatibilidade" limitado.

Corre√ß√£o Aplicada (A mais complexa): Criamos um hook de inicializa√ß√£o customizado no driver HCI (bt_hci_setup).

Implementamos uma rotina que, antes de iniciar o stack BLE, envia uma sequ√™ncia de comandos propriet√°rios da Atmel.

Essa sequ√™ncia carrega pequenos patches na RAM do BTLC1000 e configura o endere√ßo MAC correto lido da EEPROM da placa.

Resultado Final: O endere√ßo MAC correto agora aparece no scan e o r√°dio opera com m√°xima estabilidade e pot√™ncia configur√°vel.


Mudan√ßas Principais:

Clock Precision: Migra√ß√£o do clock do SERCOM4 para FDPLL96M (fix erro de baud rate).

UART Reliability: Ativa√ß√£o obrigat√≥ria de RTS/CTS no overlay do DeviceTree (fix buffer overrun).

Vendor Setup: Adi√ß√£o da fun√ß√£o btlc1000_setup_quirk() para enviar a sequ√™ncia de inicializa√ß√£o propriet√°ria e patches de RAM.

Testes Realizados:

Teste de transfer√™ncia de arquivo de 1MB via NUS (Sucesso, sem quedas).

Teste de conex√£o/desconex√£o r√°pida (100 ciclos) (Sucesso).

Valida√ß√£o com analisador l√≥gico Saleae.
